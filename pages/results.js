import React, { useState, useEffect } from 'react';
import Head from 'next/head';
import { useRouter } from 'next/router';
import { RISK_LEVELS, parseAnalysisResponse, extractSignals, calculateConfidence } from '../lib/riskMapping';

export default function Results() {
  const router = useRouter();
  const [result, setResult] = useState(null);
  const [riskData, setRiskData] = useState(null);
  const [signals, setSignals] = useState([]);
  const [confidence, setConfidence] = useState(0);

  useEffect(() => {
    const stored = sessionStorage.getItem('analysisResult');
    if (!stored) {
      router.push('/');
      return;
    }

    const data = JSON.parse(stored);
    setResult(data);

    // Process the analysis
    const parsed = parseAnalysisResponse(data.analysis);
    setRiskData(parsed);

    const extractedSignals = extractSignals(data.analysis);
    setSignals(extractedSignals);

    const conf = calculateConfidence(extractedSignals, data.framesAnalyzed || 6);
    setConfidence(conf);
  }, [router]);

  const handleDownloadPDF = async () => {
    // For MVP, generate a simple text report
    const reportContent = `
VIDEO AUTHENTICITY REPORT
Generated: ${new Date().toLocaleString()}

FILE INFORMATION
----------------
File Name: ${result.fileName}
File Size: ${(result.fileSize / (1024 * 1024)).toFixed(2)} MB
Frames Analyzed: ${result.framesAnalyzed}

RISK ASSESSMENT
---------------
Risk Level: ${riskData?.riskInfo?.label || 'Unknown'}
Confidence: ${confidence}%

${riskData?.riskInfo?.description || ''}

DETECTED SIGNALS
----------------
${signals.map(s => `[${s.severity.toUpperCase()}] ${s.category}: ${s.signal}`).join('\n')}

DETAILED ANALYSIS
-----------------
${result.analysis}

---
Report generated by Video Verify
AI-powered deepfake detection
    `.trim();

    const blob = new Blob([reportContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `video-verify-report-${Date.now()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const handleNewAnalysis = () => {
    sessionStorage.removeItem('analysisResult');
    router.push('/');
  };

  if (!result || !riskData) {
    return (
      <div className="container">
        <div className="loading-overlay" style={{ position: 'relative', minHeight: '50vh' }}>
          <div className="spinner" />
          <div className="loading-text">Loading results...</div>
        </div>
      </div>
    );
  }

  const riskClass = riskData.riskLevel.toLowerCase();

  return (
    <>
      <Head>
        <title>Analysis Results - Video Verify</title>
      </Head>

      <div className="container">
        <header className="header">
          <h1>Analysis Complete</h1>
          <p>{result.fileName}</p>
        </header>

        {/* Risk Badge */}
        <div style={{ textAlign: 'center', marginBottom: 32 }}>
          <div className={`risk-badge ${riskClass}`}>
            {riskClass === 'low' && (
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <polyline points="22 4 12 14.01 9 11.01" />
              </svg>
            )}
            {riskClass === 'medium' && (
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10" />
                <line x1="12" y1="8" x2="12" y2="12" />
                <line x1="12" y1="16" x2="12.01" y2="16" />
              </svg>
            )}
            {riskClass === 'high' && (
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                <line x1="12" y1="9" x2="12" y2="13" />
                <line x1="12" y1="17" x2="12.01" y2="17" />
              </svg>
            )}
            {riskData.riskInfo.label}
          </div>
          <p style={{ color: 'var(--text-secondary)', maxWidth: 500, margin: '0 auto' }}>
            {riskData.riskInfo.description}
          </p>
        </div>

        {/* Confidence Score */}
        <div className="result-card">
          <h3>Confidence Score</h3>
          <div className="confidence-meter">
            <div className="confidence-bar">
              <div className="confidence-fill" style={{ width: `${confidence}%` }} />
            </div>
            <div className="confidence-value">{confidence}%</div>
          </div>
        </div>

        {/* Detected Signals */}
        <div className="result-card">
          <h3>Detected Signals</h3>
          <ul className="signals-list">
            {signals.map((signal, index) => (
              <li key={index} className="signal-item">
                <div className={`signal-indicator ${signal.severity}`} />
                <div className="signal-content">
                  <div className="signal-category">{signal.category}</div>
                  <div className="signal-text">{signal.signal}</div>
                </div>
              </li>
            ))}
          </ul>
        </div>

        {/* Analyzed Frames */}
        {result.frames && result.frames.length > 0 && (
          <div className="result-card">
            <h3>Analyzed Frames ({result.frames.length} consecutive frames)</h3>
            <div className="frames-grid">
              {result.frames.map((frame, index) => {
                const showSegmentLabel = index === 0 ||
                  (frame.segment && result.frames[index - 1]?.segment !== frame.segment);
                return (
                  <React.Fragment key={index}>
                    {showSegmentLabel && frame.segment && (
                      <div className="segment-label">
                        Segment {frame.segment} ({frame.timestamp?.toFixed(1)}s)
                      </div>
                    )}
                    <div className="frame-thumb">
                      <img src={frame.data} alt={`Frame ${index + 1}`} />
                    </div>
                  </React.Fragment>
                );
              })}
            </div>
          </div>
        )}

        {/* Detailed Analysis */}
        <div className="result-card">
          <h3>Detailed Analysis</h3>
          <div className="analysis-text">{result.analysis}</div>
        </div>

        {/* Actions */}
        <div className="actions">
          <button className="btn btn-primary" onClick={handleDownloadPDF}>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7 10 12 15 17 10" />
              <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
            Download Report
          </button>
          <button className="btn btn-secondary" onClick={handleNewAnalysis}>
            Analyze Another Video
          </button>
        </div>
      </div>
    </>
  );
}
